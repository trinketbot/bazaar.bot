name: Marketplace Bot

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout bot code
        uses: actions/checkout@v4
        with:
          path: bot

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Clone discord.js main branch
        run: git clone --depth=1 https://github.com/discordjs/discord.js.git /tmp/discordjs

      - name: Install monorepo dependencies
        working-directory: /tmp/discordjs
        run: pnpm install --no-frozen-lockfile

      - name: Build discord.js from source
        working-directory: /tmp/discordjs
        run: pnpm turbo run build --filter=discord.js

      - name: Copy bot files into monorepo workspace
        run: |
          cp bot/index.js /tmp/discordjs/index.js
          cp bot/cooldowns.json /tmp/discordjs/cooldowns.json 2>/dev/null || echo '{}' > /tmp/discordjs/cooldowns.json
          cp bot/threads.json /tmp/discordjs/threads.json 2>/dev/null || echo '{}' > /tmp/discordjs/threads.json

      - name: Run marketplace bot
        working-directory: /tmp/discordjs
        env:
          MARKETPLACE_TOKEN: ${{ secrets.MARKETPLACE_TOKEN }}
        run: node index.js
